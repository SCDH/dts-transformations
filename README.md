# DTS Transformations

[![Tests](https://github.com/SCDH/dts-transformations/actions/workflows/test.yaml/badge.svg)](https://github.com/SCDH/dts-transformations/actions/workflows/test.yaml)
[![Create release](https://github.com/SCDH/dts-transformations/actions/workflows/deploy.yaml/badge.svg)](https://github.com/SCDH/dts-transformations/actions/workflows/deploy.yaml)


This project provides XSLT stylesheets for those endpoints of
[Distributed Text Services
(DTS)](https://distributed-text-services.github.io/specifications/),
that can be implemented generically.

- **navigation** endpoint
- **document** endpoint

The other endpoints are not targeted by this project. But there are
[recommendations](#other-endpoints).

## Status of Implementation

Implemented version: [1.0rc1](https://distributed-text-services.github.io/specifications/versions/1.0rc1/)

Query parameters for the endpoints are supported through stylesheet
parameters:

| parameter   | [navigation](https://distributed-text-services.github.io/specifications/versions/1.0rc1/#uri-for-navigation-endpoint-requests) | [document](https://distributed-text-services.github.io/specifications/versions/1.0rc1/#query-parameters-2) |
|-------------|--------------------------------------------------------------------------------------------------------------------------------|------------------------------------------------------------------------------------------------------------|
| `resource`  | ✅                                                                                                                             | ✅                                                                                                         |
| `ref`       | ✅                                                                                                                             | ✅                                                                                                         |
| `start`     | ✅                                                                                                                             | ✅                                                                                                         |
| `end`       | ✅                                                                                                                             | ✅                                                                                                         |
| `down`      | ✅                                                                                                                             | not used                                                                                                   |
| `tree`      | ✅                                                                                                                             | ✅                                                                                                         |
| `page`      | ❌                                                                                                                             | not used                                                                                                   |
| `mediaType` | not used                                                                                                                       | ✅[¹](#mediatype)                                                                                                        |

Evaluated TEI elements:

| element                                                                                          | navigation | document |
|--------------------------------------------------------------------------------------------------|------------|----------|
| [`<refsDecl>`](https://www.tei-c.org/release/doc/tei-p5-doc/en/html/ref-refsDecl.html)           | ✅         | ✅       |
| [`<citeStructure>`](https://www.tei-c.org/release/doc/tei-p5-doc/en/html/ref-citeStructure.html) | ✅         | ✅       |
| [`<citeData>`](https://www.tei-c.org/release/doc/tei-p5-doc/en/html/ref-citeData.html)           | ❌         | ❌       |



## XSLT for Endpoints

### Navigation

The [`xsl/navigation.xsl`](xsl/navigation.xsl) XSLT package generates
the
[`dts:Navigation`](https://distributed-text-services.github.io/specifications/versions/1.0rc1/#scheme-for-navigation-endpoint-responses)
JSON-LD object as required by the navigation endpoint. Members are
generated by evaluating
[`tei:citeStructure`](https://www.tei-c.org/release/doc/tei-p5-doc/en/html/ref-citeStructure.html)
elements in the processed TEI document.

`xsl/navigation.xsl` can either be applied on a TEI source document,
e.g. `test/matt.xml`

```shell
$SAXON_CMD -xsl:saxon-local.xml -xsl:xsl/navigation.xsl -s:test/matt.xml
```

... or it can be called with an initial template (the default initial
template `xsl:initial-template`) where the source URL can then be
passed as the `resource` stylesheet parameter:

```shell
$SAXON_CMD -xsl:saxon-local.xml -xsl:xsl/navigation.xsl -it resource=test/matt.xml
```

When a source document is processed, the `resource` stylesheet
parameter can be used to set the source's URI in multiple properties
of the JSON-LD output.

### Document

The [`xsl/document.xsl`](xsl/document.xsl) XSLT package implements the
either full or part-wise delivery of a TEI document.

Just as `xsl/navigation.xsl`, also `xsl/document.xsl` can be applied
on a source document (where the `resource` parameter can be used to
reset the resource identifier)

```shell
$SAXON_CMD -xsl:saxon-local.xml -xsl:xsl/document.xsl -s:test/matt.xml
```

... or it can be called with the default initial template:

```shell
$SAXON_CMD -xsl:saxon-local.xml -xsl:xsl/document.xsl -it resource=test/matt.xml
```


## Getting started

### First shot via remote

All XSLT related material is on [github
pages](https://scdh.github.io/dts-transform/saxon.he.xml) with the
repo's directory structure. If you have Saxon HE at hand, simply use
it as follows.

Setup:

```shell
export SAXON_CMD="java -cp ... net.sf.saxon.Transform"
export DTST=https://scdh.github.io/dts-transformations/latest
```
Transforming:

```shell
$SAXON_CMD -config:$DTST/saxon.he.xml -xsl:$DTST/xsl/navigation.xsl -s:YOUR_TEI.xml
```

### Oxygen Framework

You can install the transformations bundled in an Oxygen
framework. The framework works on top of the `TEI P5` framework and
its transformation scenarios support you well in writing cite
structure declarations with `<refsDecl>` and `<citeStructure>`
elements. The framework can simply be installed by putting the
following URL into the dialog box in **Help** > **Install new add-ons
...**.

```
https://scdh.github.io/dts-transformations/descriptor.xml
```

### Released packages

You can download stable released zip packages of the project. They are
available as [release assets](/SCDH/dts-transformations/releases).


### Cloning

You can also clone this repo and set up and use its conveniant
[Tooling](https://github.com/scdh/tooling) like so:

Setup:

```shell
# git clone ...
cd dts-transformations
./mvnw package            # sets up tooling
```

Transforming:


```shell
target/bin/xslt.sh -config:saxon.he.xml -xsl:xsl/navigation.xsl -s:test/matt.xml
```


## Customization

### mediaType

Processing of the `mediaType` parameter is a matter of post-processing
the result of applying [`xsl/document.xsl`](xsl/document.xsl). It is
thus is up to customization. There are several approaches:

1. **chaining** the output of the `xsl/document.xsl` to another
   transformation which evaluates the `mediaType` parameter
2. **importing** parts of `xsl/document.xsl` in an third stylesheet
   that processes `mediaType`
3. **compile time customization** of `xsl/document.xsl` through its
   static parameters which determine a `media-type-package`, its
   version, and how it is called for processing `mediaType`

The first option wins the award of straighforwardness, but may have a
downside: The source-document context of the nodes will probably be
lost during the post-processing phase. The other approaches can get
the full benefit from the nice feature, that the nodes returned by the
two `dts:cut-...#1` functions in
[`xsl/document.xsl`](xsl/document.xsl) are still in the context of the
source document (node identity). So you can probably use your
well-written stylesheets for getting HTML, plain text, LaTeX, etc,
even for parts of your documents.

For the third option, see the example `post-proc-(apply|call|fun).xsl`
packages in the [`test`](test) folder.

### URL Templates

URL templates, which are required for the output of the
[`dts:Resource`](https://distributed-text-services.github.io/specifications/versions/1.0rc1/#scheme-for-navigation-endpoint-responses)
LOD object, must of course be adaptable to specific project
needs. Generally, adaption can be done by implementing an URL template
XSLT package named
`https://scdh.github.io/dts-transformations/xsl/url-templates.xsl`,
version 1.0.0, and tell the XSLT processor to use it instead of the
default one through the [Saxon configuration
file](https://www.saxonica.com/documentation12/index.html#!configuration/configuration-file/config-xsltPackages),
like in [`saxon-local.xml`](saxon-local.xml).

There are alternative implementations in this project:

- `xsl/url-templates-with-query-parameters.xsl`
- `xsl/url-templates-with-selection.xsl`

### Additional Metadata

`xsl/navigation.xsl` offers customization points for adding metadata
and other LOD properties to the member objects.

1. The mode `member-metadata` can be used to add additional elements
   to the intermediate `<dts:member>` elements. The mode es called for
   each of the source's nodes (forrests) selected by a
   `citeStructure/@match`. This mode does not contain any templates
   but the default `shallow-skip`isch ones.
2. The function `dts:member-metadata-json#1` can be used to access
   these additional elements in order to output additional LOD
   properties to the member objects.

## Other Endpoints

The **collection** endpoint is not targeted by this project. We
recommend to first extract an RDF-based knowledge graph from your set
of documents using
[xtriples-micro](https://github.com/scdh/xtriples-micro) and to then
use SPARQL and JSON-LD Framing for generating the collection objects
from it. We have documented this approach in the [xtriples-micro's
Wiki](https://github.com/SCDH/xtriples-micro/wiki). The **entry**
endpoint is more a task for a text editor.

## Contributing

Contributions of all kinds are well come. Please see the [contributing
guide](CONTRIBUTING.md).

## License

MIT
